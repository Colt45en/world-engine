<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tier-4 Collaborative Demo</title>
    <style>
        body {
            font-family: 'Segoe UI', monospace;
            background: #0d1117;
            color: #c9d1d9;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            height: 100vh;
        }

        .panel {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel h2 {
            margin-top: 0;
            color: #f0f6fc;
            font-size: 18px;
            border-bottom: 1px solid #30363d;
            padding-bottom: 10px;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .status.connected {
            background: #0d4f3c;
            border: 1px solid #238636;
            color: #46d158;
        }

        .status.disconnected {
            background: #67060c;
            border: 1px solid #da3633;
            color: #f85149;
        }

        .event-log {
            flex: 1;
            overflow-y: auto;
            font-family: 'Fira Code', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .event {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            border-left: 3px solid #30363d;
        }

        .event.nucleus_exec {
            border-left-color: #1f6feb;
            background: #0c2d6b10;
        }

        .event.memory_store {
            border-left-color: #f85149;
            background: #67060c10;
        }

        .event.tier4_state_update {
            border-left-color: #a5f3fc;
            background: #0891b210;
        }

        .event.cycle_start {
            border-left-color: #46d158;
            background: #0d4f3c10;
        }

        .controls {
            margin-top: 15px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        button {
            background: #21262d;
            border: 1px solid #30363d;
            color: #f0f6fc;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        button:hover {
            background: #30363d;
            border-color: #484f58;
        }

        button:active {
            background: #1c2128;
        }

        button.operator {
            background: #1f6feb;
            border-color: #1f6feb;
        }

        button.macro {
            background: #da3633;
            border-color: #da3633;
        }

        .state-display {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            font-family: 'Fira Code', monospace;
        }

        .vector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }

        .vector-component {
            text-align: center;
            padding: 8px;
            background: #21262d;
            border-radius: 4px;
            font-size: 14px;
        }

        .participants {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .participant {
            background: #1f6feb;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        input[type="text"] {
            background: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 8px;
            border-radius: 4px;
            width: 100%;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- WebSocket Events Panel -->
        <div class="panel">
            <h2>üåê WebSocket Events</h2>
            <div id="ws-status" class="status disconnected">
                Disconnected from ws://localhost:9000
            </div>
            <div class="event-log" id="ws-events"></div>
            <div class="controls">
                <button onclick="try { connectWebSocket(); } catch(e) { console.error(\'Button error:\', e); }">Connect</button>
                <button onclick="try { disconnectWebSocket(); } catch(e) { console.error(\'Button error:\', e); }">Disconnect</button>
                <button onclick="try { clearEvents(); } catch(e) { console.error(\'Button error:\', e); }">Clear</button>
            </div>
        </div>

        <!-- Tier-4 State Panel -->
        <div class="panel">
            <h2>üß† Tier-4 State</h2>
            <div class="state-display">
                <div>Session: <span id="session-id">-</span></div>
                <div>User: <span id="user-id">anonymous</span></div>
                <div>Last Op: <span id="last-op">-</span></div>
                <div>Level: <span id="level">0</span></div>
                <div>Œ∫: <span id="kappa">0.60</span></div>

                <div style="margin-top: 15px;">State Vector [p, i, g, c]:</div>
                <div class="vector">
                    <div class="vector-component">p: <span id="p-val">0.000</span></div>
                    <div class="vector-component">i: <span id="i-val">0.500</span></div>
                    <div class="vector-component">g: <span id="g-val">0.400</span></div>
                    <div class="vector-component">c: <span id="c-val">0.600</span></div>
                </div>
            </div>

            <div>
                <input type="text" id="session-input" placeholder="Enter session ID" />
                <button onclick="try { joinSession(); } catch(e) { console.error(\'Button error:\', e); }">Join Session</button>
            </div>

            <div class="participants">
                <div>Participants:</div>
                <div id="participants-list"></div>
            </div>

            <div class="controls">
                <button class="operator" onclick="applyOperator('ST')">ST</button>
                <button class="operator" onclick="applyOperator('UP')">UP</button>
                <button class="operator" onclick="applyOperator('PR')">PR</button>
                <button class="operator" onclick="applyOperator('CV')">CV</button>
                <button class="operator" onclick="applyOperator('RB')">RB</button>
                <button class="operator" onclick="applyOperator('RS')">RS</button>
                <button class="macro" onclick="runMacro('IDE_A')">IDE_A</button>
                <button class="macro" onclick="runMacro('IDE_B')">IDE_B</button>
                <button class="macro" onclick="runMacro('MERGE_ABC')">MERGE</button>
            </div>
        </div>

        <!-- Nucleus Activity Panel -->
        <div class="panel">
            <h2>‚öõÔ∏è Nucleus Activity</h2>
            <div class="event-log" id="nucleus-events"></div>
            <div class="controls">
                <button onclick="triggerNucleus('VIBRATE')">Vibrate</button>
                <button onclick="triggerNucleus('OPTIMIZATION')">Optimize</button>
                <button onclick="triggerNucleus('STATE')">State</button>
                <button onclick="try { injectCycle(); } catch(e) { console.error(\'Button error:\', e); }">Inject Cycle</button>
                <button onclick="try { simulateHallucination(); } catch(e) { console.error(\'Button error:\', e); }">Hallucination</button>
                <button onclick="try { clearNucleusEvents(); } catch(e) { console.error(\'Button error:\', e); }">Clear</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let ws = null;
        let currentState = { x: [0, 0.5, 0.4, 0.6], kappa: 0.6, level: 0 };
        let sessionId = null;
        let userId = `user_${Math.random().toString(36).substr(2, 8)}`;
        let participants = [];

        // DOM elements
        const wsStatus = document.getElementById('ws-status');
        const wsEvents = document.getElementById('ws-events');
        const nucleusEvents = document.getElementById('nucleus-events');

        // ============================= WebSocket Connection =============================

        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                return;
            }

            ws = new WebSocket('ws://localhost:9000');

            ws.onopen = () => {
                wsStatus.className = 'status connected';
                wsStatus.textContent = 'Connected to ws://localhost:9000';
                addEvent(wsEvents, 'connection', { type: 'connected', ts: new Date().toISOString() });
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    addEvent(wsEvents, 'error', { type: 'parse_error', message: event.data });
                }
            };

            ws.onclose = () => {
                wsStatus.className = 'status disconnected';
                wsStatus.textContent = 'Disconnected from ws://localhost:9000';
                addEvent(wsEvents, 'connection', { type: 'disconnected', ts: new Date().toISOString() });
            };

            ws.onerror = (error) => {
                addEvent(wsEvents, 'error', { type: 'connection_error', error: error.message });
            };
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        // ============================= Message Handling =============================

        function handleWebSocketMessage(data) {
            // Add to appropriate event log
            if (data.type?.startsWith('nucleus_') || data.type === 'cycle_start' || data.type === 'cycle_end' || data.type === 'memory_store') {
                addEvent(nucleusEvents, data.type, data);

                // Auto-apply Tier-4 operators based on nucleus events
                if (data.tier4_operator) {
                    setTimeout(() => {
                        applyOperatorFromNucleus(data.tier4_operator, data);
                    }, 100);
                }
            } else {
                addEvent(wsEvents, data.type, data);
            }

            // Handle specific event types
            switch (data.type) {
                case 'tier4_welcome':
                    sessionId = data.clientId;
                    updateStateDisplay();
                    break;

                case 'tier4_state_update':
                    if (data.sessionId !== sessionId) {
                        currentState = data.state;
                        updateStateDisplay();
                        addEvent(wsEvents, 'remote_update', {
                            from: data.metadata.userId,
                            operator: data.lastOperator
                        });
                    }
                    break;

                case 'tier4_session_joined':
                    participants = data.participants;
                    updateParticipants();
                    break;

                case 'tier4_participant_joined':
                case 'tier4_participant_left':
                    participants = data.participants;
                    updateParticipants();
                    break;
            }
        }

        function addEvent(container, type, data) {
            const event = document.createElement('div');
            event.className = `event ${type}`;

            const timestamp = data.ts || new Date().toISOString();
            const timeStr = new Date(timestamp).toLocaleTimeString();

            let content = `<strong>${timeStr}</strong> [${type}]`;

            // Format specific event types
            if (type === 'nucleus_exec') {
                content += ` ${data.id} (${data.role})`;
                if (data.tier4_operator) {
                    content += ` ‚Üí <span style="color: #1f6feb">${data.tier4_operator}</span>`;
                }
            } else if (type === 'memory_store') {
                content += ` "${data.tag}": ${data.thought}`;
                if (data.tier4_operator) {
                    content += ` ‚Üí <span style="color: #f85149">${data.tier4_operator}</span>`;
                }
            } else if (type === 'cycle_start') {
                content += ` Cycle ${data.cycle}/${data.total}`;
                if (data.tier4_suggested_macro) {
                    content += ` ‚Üí <span style="color: #46d158">${data.tier4_suggested_macro}</span>`;
                }
            } else if (type === 'tier4_state_update') {
                content += ` ${data.lastOperator} by ${data.metadata.userId}`;
                content += ` (Œ∫=${(data.state.kappa * 100).toFixed(0)}%)`;
            } else {
                content += ` ${JSON.stringify(data, null, 2).slice(0, 100)}`;
                if (JSON.stringify(data).length > 100) content += '...';
            }

            event.innerHTML = content;
            container.appendChild(event);
            container.scrollTop = container.scrollHeight;
        }

        // ============================= Tier-4 Operations =============================

        function applyOperator(operator) {
            // Apply to local state
            currentState = transformState(currentState, operator);
            updateStateDisplay();

            // Broadcast to other clients
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'tier4_state_update',
                    sessionId: sessionId,
                    state: currentState,
                    lastOperator: operator,
                    metadata: {
                        userId: userId,
                        source: 'manual',
                        confidence: currentState.kappa
                    },
                    ts: new Date().toISOString()
                }));
            }

            addEvent(wsEvents, 'operator_applied', { operator, state: currentState });
        }

        function applyOperatorFromNucleus(operator, nucleusData) {
            // Auto-apply operator triggered by nucleus
            currentState = transformState(currentState, operator);
            updateStateDisplay();

            addEvent(wsEvents, 'auto_operator', {
                operator,
                trigger: nucleusData.type,
                nucleus: nucleusData.id || nucleusData.role
            });
        }

        function runMacro(macro) {
            const sequences = {
                IDE_A: ['ST', 'SL', 'CP'],
                IDE_B: ['CV', 'PR', 'RC'],
                IDE_C: ['TL', 'RB', 'MD'],
                MERGE_ABC: ['CV', 'CV', 'ST', 'SL', 'CP', 'CV', 'PR', 'RC', 'TL', 'RB', 'MD']
            };

            const sequence = sequences[macro] || [macro];

            addEvent(wsEvents, 'macro_start', { macro, sequence });

            sequence.forEach((op, index) => {
                setTimeout(() => {
                    applyOperator(op);
                    if (index === sequence.length - 1) {
                        addEvent(wsEvents, 'macro_complete', { macro });
                    }
                }, index * 200);
            });
        }

        function transformState(state, operator) {
            // Simplified operator transformations
            const operators = {
                ST: { M: [[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]], b: [0,0,0,0], kappaDelta: 0 },
                UP: { M: [[1,0,0,0],[0,1.05,0,0],[0,0,1,0],[0,0,0,1.05]], b: [0,0.01,0,0.01], kappaDelta: 0 },
                PR: { M: [[1,0,0,0],[0,0.9,0,0],[0,0,1,0],[0,0,0,1.1]], b: [0,-0.02,0,0.02], kappaDelta: 0.1 },
                CV: { M: [[0.95,0,0,0],[0,1,0,0],[0,0,1.1,0],[0,0,0,1]], b: [0,0,0.01,0.01], kappaDelta: -0.05 },
                RB: { M: [[1,0,0,0],[0,1.05,0,0],[0,0,1.05,0],[0,0,0,0.95]], b: [0,0.02,0.03,-0.01], kappaDelta: 0 }
            };

            const op = operators[operator] || operators.ST;

            // Matrix-vector multiplication
            const newX = new Array(4);
            for (let i = 0; i < 4; i++) {
                let sum = 0;
                for (let j = 0; j < 4; j++) {
                    sum += op.M[i][j] * state.x[j];
                }
                newX[i] = sum + op.b[i];
            }

            return {
                x: newX,
                kappa: Math.max(0, Math.min(1, state.kappa + op.kappaDelta)),
                level: state.level + (operator === 'UP' ? 1 : operator === 'RB' ? -1 : 0)
            };
        }

        // ============================= Session Management =============================

        function joinSession() {
            const sessionInput = document.getElementById('session-input');
            const newSessionId = sessionInput.value.trim();

            if (!newSessionId) {
                alert('Please enter a session ID');
                return;
            }

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'tier4_join_session',
                    sessionId: newSessionId,
                    userId: userId,
                    ts: new Date().toISOString()
                }));

                sessionId = newSessionId;
                updateStateDisplay();
                sessionInput.value = '';
            }
        }

        // ============================= Nucleus Simulation =============================

        function triggerNucleus(role) {
            const event = {
                type: 'nucleus_exec',
                ts: new Date().toISOString(),
                id: `N${Math.floor(Math.random() * 4) + 1}`,
                role: role,
                state: 'active'
            };

            // Inject locally first
            addEvent(nucleusEvents, 'nucleus_exec', event);

            // Send to relay if connected
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(event));
            }
        }

        function injectCycle() {
            const cycle = Math.floor(Math.random() * 3) + 1;
            const event = {
                type: 'cycle_start',
                ts: new Date().toISOString(),
                cycle: cycle,
                total: 3
            };

            addEvent(nucleusEvents, 'cycle_start', event);

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(event));
            }
        }

        function simulateHallucination() {
            const event = {
                type: 'hallucination_guard',
                ts: new Date().toISOString(),
                nucleus: `N${Math.floor(Math.random() * 4) + 1}`,
                need_tag: ['energy', 'refined', 'condition'][Math.floor(Math.random() * 3)]
            };

            addEvent(nucleusEvents, 'hallucination_guard', event);

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(event));
            }
        }

        // ============================= UI Updates =============================

        function updateStateDisplay() {
            document.getElementById('session-id').textContent = sessionId || '-';
            document.getElementById('user-id').textContent = userId;
            document.getElementById('level').textContent = currentState.level;
            document.getElementById('kappa').textContent = currentState.kappa.toFixed(2);

            document.getElementById('p-val').textContent = currentState.x[0].toFixed(3);
            document.getElementById('i-val').textContent = currentState.x[1].toFixed(3);
            document.getElementById('g-val').textContent = currentState.x[2].toFixed(3);
            document.getElementById('c-val').textContent = currentState.x[3].toFixed(3);
        }

        function updateParticipants() {
            const list = document.getElementById('participants-list');
            list.innerHTML = participants.map(p =>
                `<div class="participant">${p}</div>`
            ).join('');
        }

        function clearEvents() {
            wsEvents.innerHTML = '';
        }

        function clearNucleusEvents() {
            nucleusEvents.innerHTML = '';
        }

        // ============================= Initialization =============================

        document.addEventListener('DOMContentLoaded', () => {
            updateStateDisplay();
            connectWebSocket();
        });
    </script>
</body>
</html>
